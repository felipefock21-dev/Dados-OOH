<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Dados OOH</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <main>
      <!-- SE√á√ÉO DE BOT√ïES PRINCIPAIS -->
      <section class="buttons-section">
        <h1 class="page-title">Como est√° o status da campanha?</h1>
        <div class="buttons-container">
          <button id="btnAtivo" class="btn btn-ativo">
            <span class="btn-label">ATIVO</span>
          </button>
          <button id="btnInativo" class="btn btn-inativo">
            <span class="btn-label">INATIVO</span>
          </button>
        </div>
      </section>

      <!-- TABELA DE CLIENTES -->
      <section class="table-section" id="tabelaSectionContainer" style="display: none;">
        <div class="table-header">
          <h2 id="tituloTabela">Clientes Ativos</h2>
          <input 
            type="text" 
            id="searchInput" 
            placeholder="üîç Buscar cliente..."
            class="search-input"
          >
        </div>
        <div id="loadingSpinner" class="spinner">Carregando clientes...</div>
        <div id="errorMessage" class="error-message"></div>
        
        <table id="tabelaDados" class="table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Status</th>
              <th>Campanhas</th>
              <th>Investimento Total</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaDadosBody">
          </tbody>
        </table>
      </section>
    </main>

    <!-- MODAL DE FORMUL√ÅRIO -->
    <div id="modalFormulario" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitulo">Novo Registro</h2>
        
        <form id="formularioDados">
          <div class="form-group">
            <label for="cliente">Cliente</label>
            <input type="text" id="cliente" name="Cliente" required>
          </div>
          
          <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="Status Cliente">
              <option value="Ativo">Ativo</option>
              <option value="Inativo">Inativo</option>
            </select>
          </div>

          <div class="form-group">
            <label for="campanha">Campanha</label>
            <input type="text" id="campanha" name="Campanha">
          </div>

          <div class="form-group">
            <label for="investimento">Investimento</label>
            <input type="text" id="investimento" name="Investimento" placeholder="R$ 0,00">
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvar</button>
            <button type="button" id="btnCancelar" class="btn btn-secondary">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="modalConfirmacao" class="modal">
      <div class="modal-content">
        <h2>Confirmar Dele√ß√£o</h2>
        <p id="msgConfirmacao">Tem certeza?</p>
        <div class="form-actions">
          <button id="btnConfirmarDelete" class="btn btn-danger">Deletar</button>
          <button id="btnCancelarDelete" class="btn btn-secondary">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURA√á√ÉO DA API
    // ============================================
    
    // Usar Worker direto (secrets configurados no Cloudflare)
    const API_BASE = 'https://dados-ooh-worker.kaike-458.workers.dev/api';
    
    console.log('üöÄ API_BASE:', API_BASE);
    
    // ============================================
    // ESTADO E DOM
    // ============================================
    
    let dados = [];
    let registroEmEdicao = null;
    let statusFiltroAtual = null; // 'Ativo', 'Inativo', ou null

    const modal = document.getElementById('modalFormulario');
    const modalConfirmacao = document.getElementById('modalConfirmacao');
    const btnAtivo = document.getElementById('btnAtivo');
    const btnInativo = document.getElementById('btnInativo');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnCancelarDelete = document.getElementById('btnCancelarDelete');
    const btnConfirmarDelete = document.getElementById('btnConfirmarDelete');
    const formulario = document.getElementById('formularioDados');
    const tabelaDadosBody = document.getElementById('tabelaDadosBody');
    const tabelaSectionContainer = document.getElementById('tabelaSectionContainer');
    const tituloTabela = document.getElementById('tituloTabela');
    const searchInput = document.getElementById('searchInput');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');

    // ============================================
    // EVENT LISTENERS
    // ============================================
    
    btnAtivo.addEventListener('click', () => filtrarPorStatus('Ativo'));
    btnInativo.addEventListener('click', () => filtrarPorStatus('Inativo'));
    btnCancelar.addEventListener('click', fecharModal);
    document.querySelector('.close').addEventListener('click', fecharModal);
    formulario.addEventListener('submit', salvarRegistro);

    window.addEventListener('load', carregarDados);

    // ============================================
    // FUN√á√ïES PRINCIPAIS
    // ============================================

    async function carregarDados() {
      try {
        loadingSpinner.style.display = 'block';
        errorMessage.classList.remove('active');
        
        const response = await fetch(`${API_BASE}/dados`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Erro HTTP ${response.status}: ${errorData.erro || response.statusText}`);
        }
        
        dados = await response.json();
        
        if (!Array.isArray(dados)) {
          dados = [];
        }
        
        atualizarTabela();
        loadingSpinner.style.display = 'none';
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        mostrarErro(`‚ùå Erro ao carregar dados: ${error.message}`);
        dados = [];
        atualizarTabela();
        loadingSpinner.style.display = 'none';
      }
    }

    function atualizarTabela() {
      tabelaDadosBody.innerHTML = '';
      
      // Obter clientes √∫nicos
      const clientesUnicos = {};
      dados.forEach((registro) => {
        const cliente = registro['Cliente'] || '-';
        if (!clientesUnicos[cliente]) {
          clientesUnicos[cliente] = {
            nome: cliente,
            status: registro['Status Cliente'],
            campanhas: 0,
            investimento: 0,
            registros: []
          };
        }
        clientesUnicos[cliente].campanhas += 1;
        
        const investimento = parseFloat(
          (registro['Investimento'] || 'R$ 0,00').replace(/[^\d,]/g, '').replace(',', '.')
        );
        clientesUnicos[cliente].investimento += isNaN(investimento) ? 0 : investimento;
        clientesUnicos[cliente].registros.push(registro);
      });
      
      const clientes = Object.values(clientesUnicos).sort((a, b) => 
        a.nome.localeCompare(b.nome)
      );
      
      if (clientes.length === 0) {
        tabelaDadosBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">Nenhum cliente encontrado</td></tr>';
        return;
      }
      
      clientes.forEach((cliente, index) => {
        const linha = document.createElement('tr');
        const investimentoFormatado = `R$ ${cliente.investimento.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        linha.innerHTML = `
          <td><strong>${cliente.nome}</strong></td>
          <td><span class="status ${cliente.status.toLowerCase()}">${cliente.status}</span></td>
          <td>${cliente.campanhas}</td>
          <td>${investimentoFormatado}</td>
          <td>
            <div class="table-actions">
              <button class="btn-edit" onclick="abrirModalEditar('${cliente.nome}')">‚úèÔ∏è Editar</button>
              <button class="btn-delete" onclick="confirmarDeletar('${cliente.nome}')">üóëÔ∏è Deletar</button>
            </div>
          </td>
        `;
        
        tabelaDadosBody.appendChild(linha);
      });
    }

    function filtrarTabela() {
      const termo = searchInput.value.toLowerCase();
      const linhas = tabelaDadosBody.querySelectorAll('tr');
      
      linhas.forEach(linha => {
        const texto = linha.textContent.toLowerCase();
        if (texto.includes(termo)) {
          linha.style.display = '';
        } else {
          linha.style.display = 'none';
        }
      });
    }

    function filtrarPorStatus(status) {
      statusFiltroAtual = status;
      
      // Atualizar t√≠tulo
      tituloTabela.textContent = status === 'Ativo' ? 'Clientes Ativos' : 'Clientes Inativos';
      
      // Atualizar estilos dos bot√µes
      if (status === 'Ativo') {
        btnAtivo.classList.add('active');
        btnInativo.classList.remove('active');
      } else {
        btnInativo.classList.add('active');
        btnAtivo.classList.remove('active');
      }
      
      // Mostrar tabela
      tabelaSectionContainer.style.display = 'block';
      
      // Filtrar dados por status
      const dadosFiltrados = dados.filter(registro => {
        return registro['Status Cliente'] === status;
      });
      
      // Atualizar tabela com dados filtrados
      tabelaDadosBody.innerHTML = '';
      
      // Obter clientes √∫nicos com status filtrado
      const clientesUnicos = {};
      dadosFiltrados.forEach((registro) => {
        const cliente = registro['Cliente'] || '-';
        if (!clientesUnicos[cliente]) {
          clientesUnicos[cliente] = {
            nome: cliente,
            status: registro['Status Cliente'],
            campanhas: 0,
            investimento: 0,
            registros: []
          };
        }
        clientesUnicos[cliente].campanhas += 1;
        
        const investimento = parseFloat(
          (registro['Investimento'] || 'R$ 0,00').replace(/[^\d,]/g, '').replace(',', '.')
        );
        clientesUnicos[cliente].investimento += isNaN(investimento) ? 0 : investimento;
        clientesUnicos[cliente].registros.push(registro);
      });
      
      const clientes = Object.values(clientesUnicos).sort((a, b) => 
        a.nome.localeCompare(b.nome)
      );
      
      if (clientes.length === 0) {
        tabelaDadosBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">Nenhum cliente encontrado com status ' + status + '</td></tr>';
        return;
      }
      
      clientes.forEach((cliente, index) => {
        const linha = document.createElement('tr');
        const investimentoFormatado = `R$ ${cliente.investimento.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        linha.innerHTML = `
          <td><strong>${cliente.nome}</strong></td>
          <td><span class="status ${cliente.status.toLowerCase()}">${cliente.status}</span></td>
          <td>${cliente.campanhas}</td>
          <td>${investimentoFormatado}</td>
          <td>
            <div class="table-actions">
              <button class="btn-edit" onclick="abrirModalEditar('${cliente.nome}')">‚úèÔ∏è Editar</button>
              <button class="btn-delete" onclick="confirmarDeletar('${cliente.nome}')">üóëÔ∏è Deletar</button>
            </div>
          </td>
        `;
        
        tabelaDadosBody.appendChild(linha);
      });
      
      // Atualizar listener de busca
      searchInput.addEventListener('input', filtrarTabela);
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================

    function abrirModalNovoRegistro() {
      registroEmEdicao = null;
      formulario.reset();
      document.getElementById('modalTitulo').textContent = 'Novo Cliente';
      modal.classList.add('active');
    }

    function abrirModalEditar(nomeCliente) {
      registroEmEdicao = nomeCliente;
      
      const primeiroRegistro = dados.find(d => d['Cliente'] === nomeCliente);
      
      if (!primeiroRegistro) {
        mostrarErro('Cliente n√£o encontrado');
        return;
      }
      
      document.getElementById('modalTitulo').textContent = 'Editar Cliente: ' + nomeCliente;
      
      Object.keys(primeiroRegistro).forEach(chave => {
        const elemento = document.querySelector(`[name="${chave}"]`);
        if (elemento) {
          elemento.value = primeiroRegistro[chave];
        }
      });
      
      modal.classList.add('active');
    }

    function fecharModal() {
      modal.classList.remove('active');
      registroEmEdicao = null;
      formulario.reset();
    }

    function confirmarDeletar(nomeCliente) {
      document.getElementById('msgConfirmacao').textContent = 
        `Tem certeza que deseja deletar TODOS os registros do cliente "${nomeCliente}"? Esta a√ß√£o n√£o pode ser desfeita.`;
      
      btnConfirmarDelete.onclick = () => deletarCliente(nomeCliente);
      modalConfirmacao.classList.add('active');
    }

    document.addEventListener('click', (e) => {
      if (e.target === modalConfirmacao) {
        modalConfirmacao.classList.remove('active');
      }
    });

    btnCancelarDelete.addEventListener('click', () => {
      modalConfirmacao.classList.remove('active');
    });

    // ============================================
    // CRUD OPERATIONS
    // ============================================

    async function salvarRegistro(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(formulario);
        const registro = Object.fromEntries(formData);
        
        if (registroEmEdicao !== null) {
          // UPDATE
          const response = await fetch(`${API_BASE}/dados/0`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(registro)
          });
          
          if (!response.ok) {
            throw new Error('Erro ao atualizar registro');
          }
          
          mostrarSucesso('Registro atualizado com sucesso!');
        } else {
          // CREATE
          const response = await fetch(`${API_BASE}/dados`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(registro)
          });
          
          if (!response.ok) {
            throw new Error('Erro ao criar registro');
          }
          
          mostrarSucesso('Registro criado com sucesso!');
        }
        
        carregarDados();
        fecharModal();
      } catch (error) {
        console.error('Erro ao salvar:', error);
        mostrarErro(error.message || 'Erro ao salvar registro');
      }
    }

    async function deletarCliente(nomeCliente) {
      try {
        const indicesParaDeletar = dados
          .map((d, idx) => d['Cliente'] === nomeCliente ? idx : -1)
          .filter(idx => idx !== -1)
          .sort((a, b) => b - a);
        
        for (const idx of indicesParaDeletar) {
          const response = await fetch(`${API_BASE}/dados/${idx}`, {
            method: 'DELETE'
          });
          
          if (!response.ok) {
            throw new Error('Erro ao deletar registro');
          }
        }
        
        dados = dados.filter(d => d['Cliente'] !== nomeCliente);
        
        atualizarTabela();
        modalConfirmacao.classList.remove('active');
        mostrarSucesso(`Cliente "${nomeCliente}" deletado com sucesso!`);
      } catch (error) {
        console.error('Erro ao deletar cliente:', error);
        mostrarErro(error.message || 'Erro ao deletar cliente');
      }
    }

    // ============================================
    // NOTIFICA√á√ïES
    // ============================================

    function mostrarErro(mensagem) {
      errorMessage.textContent = mensagem;
      errorMessage.classList.add('active');
      setTimeout(() => {
        errorMessage.classList.remove('active');
      }, 5000);
    }

    function mostrarSucesso(mensagem) {
      const notif = document.createElement('div');
      notif.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        z-index: 2000;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      `;
      notif.textContent = '‚úì ' + mensagem;
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.remove();
      }, 3000);
    }

    // ============================================
    // UTILIDADES
    // ============================================

    function formatarNumero(num) {
      return new Intl.NumberFormat('pt-BR').format(num);
    }

    const style = document.createElement('style');
    style.textContent = `
      .status {
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85em;
      }
      
      .status.ativo {
        background: #c8e6c9;
        color: #2e7d32;
      }
      
      .status.inativo {
        background: #ffcdd2;
        color: #c62828;
      }
      
      .status.ativa {
        background: #c8e6c9;
        color: #2e7d32;
      }
      
      .status.inativa {
        background: #ffcdd2;
        color: #c62828;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
