<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Dados OOH</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="top-header">
    <img src="logo.png" alt="E-Midias Logo" class="header-logo">
  </header>
  <div class="container">
    <main>
      <!-- SE√á√ÉO DE BOT√ïES PRINCIPAIS -->
      <section class="buttons-section">
        <h1 class="page-title">Como est√° o status da campanha?</h1>
        <div class="buttons-container">
          <button id="btnAtivo" class="btn btn-ativo">
            <span class="btn-label">ATIVO</span>
          </button>
          <button id="btnInativo" class="btn btn-inativo">
            <span class="btn-label">INATIVO</span>
          </button>
        </div>
        <button id="btnAdicionarCampanha" class="btn-adicionar-campanha">
          + Adicionar nova campanha
        </button>
      </section>

      <!-- TABELA DE CLIENTES -->
      <section class="table-section" id="tabelaSectionContainer" style="display: none;">
        <div class="table-header">
          <h2 id="tituloTabela">Clientes Ativos</h2>
          <input 
            type="text" 
            id="searchInput" 
            placeholder="üîç Buscar cliente..."
            class="search-input"
          >
        </div>
        <div id="loadingSpinner" class="spinner">Carregando clientes...</div>
        <div id="errorMessage" class="error-message"></div>
        
        <table id="tabelaDados" class="table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Campanhas</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaDadosBody">
          </tbody>
        </table>
      </section>
    </main>

    <!-- MODAL DE FORMUL√ÅRIO -->
    <div id="modalFormulario" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitulo">Novo Registro</h2>
        
        <form id="formularioDados">
          <div class="form-group">
            <label for="cliente">Cliente</label>
            <input type="text" id="cliente" name="Cliente" required>
          </div>

          <div class="form-group">
            <label for="campanha">Campanha</label>
            <input type="text" id="campanha" name="Campanha">
          </div>

          <div class="form-group">
            <label for="investimento">Investimento</label>
            <input type="text" id="investimento" name="Investimento" placeholder="R$ 0,00">
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvar</button>
            <button type="button" id="btnCancelar" class="btn btn-secondary">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="modalConfirmacao" class="modal">
      <div class="modal-content">
        <h2>Confirmar Dele√ß√£o</h2>
        <p id="msgConfirmacao">Tem certeza?</p>
        <div class="form-actions">
          <button id="btnConfirmarDelete" class="btn btn-danger">Deletar</button>
          <button id="btnCancelarDelete" class="btn btn-secondary">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- MODAL DE CAMPANHAS -->
    <div id="modalCampanhas" class="modal">
      <div class="modal-content modal-content-large">
        <span class="close" id="closeCampanhas">&times;</span>
        <h2 id="tituloModalCampanhas">Visualizar Campanha</h2>
        
        <div class="campanhas-container">
          <div id="campanhasSpinner" class="spinner">Carregando campanhas...</div>
          <table id="tabelaCampanhas" class="table" style="display: none;">
            <thead>
              <tr>
                <th>Cidade</th>
                <th>Exibidora</th>
                <th>Tipo OOH</th>
                <th>In√≠cio da campanha</th>
                <th>T√©rmino da campanha</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabelaCampanhasBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MODAL DE NOVA CAMPANHA -->
    <div id="modalNovaCampanha" class="modal">
      <div class="modal-content modal-content-form">
        <span class="close" id="closeNovaCampanha">&times;</span>
        <h2>Adicionar Nova Campanha</h2>
        
        <form id="formNovaCampanha" class="form-nova-campanha">
          <!-- Linha 1: Cliente, Campanha -->
          <div class="form-row">
            <div class="form-group">
              <label for="inputCliente">Cliente *</label>
              <input type="text" id="inputCliente" placeholder="Nome do cliente" required>
            </div>
            <div class="form-group">
              <label for="inputCampanha">Campanha *</label>
              <input type="text" id="inputCampanha" placeholder="Nome da campanha" required>
            </div>
          </div>

          <!-- Linha 2: Tipo OOH, Status -->
          <div class="form-row">
            <div class="form-group">
              <label for="inputTipoOOH">Tipo de OOH *</label>
              <input type="text" id="inputTipoOOH" placeholder="Ex: Outdoor, Painel" required>
            </div>
            <div class="form-group">
              <label for="selectStatus">Status Campanha *</label>
              <select id="selectStatus" required>
                <option value="">Selecione...</option>
                <option value="Ativa">Ativa</option>
                <option value="Inativa">Inativa</option>
              </select>
            </div>
          </div>

          <!-- Linha 3: Regi√£o, Estado -->
          <div class="form-row">
            <div class="form-group">
              <label for="selectRegiao">Regi√£o *</label>
              <select id="selectRegiao" required>
                <option value="">Selecione...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="selectEstado">Estado *</label>
              <select id="selectEstado" required>
                <option value="">Selecione...</option>
              </select>
            </div>
          </div>

          <!-- Linha 4: Cidade -->
          <div class="form-row">
            <div class="form-group full-width">
              <label for="selectCidade">Cidade *</label>
              <select id="selectCidade" required>
                <option value="">Selecione um estado primeiro</option>
              </select>
            </div>
          </div>

          <!-- Linha 5: Exibidora, M√™s -->
          <div class="form-row">
            <div class="form-group">
              <label for="inputExibidora">Exibidora *</label>
              <input type="text" id="inputExibidora" placeholder="Nome da exibidora" required>
            </div>
            <div class="form-group">
              <label for="selectMes">M√™s de Exibi√ß√£o *</label>
              <select id="selectMes" required>
                <option value="">Selecione...</option>
                <option value="Janeiro">Janeiro</option>
                <option value="Fevereiro">Fevereiro</option>
                <option value="Mar√ßo">Mar√ßo</option>
                <option value="Abril">Abril</option>
                <option value="Maio">Maio</option>
                <option value="Junho">Junho</option>
                <option value="Julho">Julho</option>
                <option value="Agosto">Agosto</option>
                <option value="Setembro">Setembro</option>
                <option value="Outubro">Outubro</option>
                <option value="Novembro">Novembro</option>
                <option value="Dezembro">Dezembro</option>
              </select>
            </div>
          </div>

          <!-- Linha 6: Datas -->
          <div class="form-row">
            <div class="form-group">
              <label for="inputDataInicio">In√≠cio da Campanha *</label>
              <input type="date" id="inputDataInicio" required>
            </div>
            <div class="form-group">
              <label for="inputDataFim">T√©rmino da Campanha *</label>
              <input type="date" id="inputDataFim" required>
            </div>
          </div>

          <!-- Linha 7: Impactos e Investimento -->
          <div class="form-row">
            <div class="form-group">
              <label for="inputImpactos">Impactos Total *</label>
              <input type="number" id="inputImpactos" placeholder="0" min="0" required>
            </div>
            <div class="form-group">
              <label for="inputInvestimento">Investimento (R$) *</label>
              <input type="number" id="inputInvestimento" placeholder="0,00" step="0.01" min="0" required>
            </div>
          </div>

          <!-- Bot√µes -->
          <div class="form-actions">
            <button type="submit" class="btn-submit">Adicionar Campanha</button>
            <button type="button" class="btn-cancel" id="btnCancelNovaCampanha">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL DE LOADING -->
  <div id="modalLoading" class="modal-loading">
    <div class="loading-container">
      <!-- Estado de Loading -->
      <div id="loadingState" class="loading-state active">
        <div class="spinner"></div>
        <h2 id="loadingTitle">Estamos subindo sua campanha</h2>
        <p id="loadingSubtitle">S√≥ um minutinho...</p>
      </div>

      <!-- Estado de Sucesso -->
      <div id="successState" class="success-state">
        <div class="checkmark">‚úî</div>
        <h2 id="successTitle">T√° feito!</h2>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURA√á√ÉO DA API
    // ============================================
    // CONFIGURA√á√ÉO DE APIs
    // ============================================
    
    // Worker API para leitura (GET)
    const API_BASE = 'https://dados-ooh-worker.kaike-458.workers.dev/api';
    
    // Google Apps Script para escrita (POST)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwsCercUZNizKqFKlTzciBoPouLKh8f45xM4Vo7KRYxpyTPxW-oExUn9p_YZITXb0yVlA/exec';
    
    console.log('üöÄ API_BASE:', API_BASE);
    console.log('üìù APPS_SCRIPT_URL:', APPS_SCRIPT_URL);
    
    // ============================================
    // ESTADO E DOM
    // ============================================
    
    let dados = [];
    let registroEmEdicao = null;
    let statusFiltroAtual = null; // 'Ativo', 'Inativo', ou null

    const modal = document.getElementById('modalFormulario');
    const modalConfirmacao = document.getElementById('modalConfirmacao');
    const btnAtivo = document.getElementById('btnAtivo');
    const btnInativo = document.getElementById('btnInativo');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnCancelarDelete = document.getElementById('btnCancelarDelete');
    const btnConfirmarDelete = document.getElementById('btnConfirmarDelete');
    const formulario = document.getElementById('formularioDados');
    const tabelaDadosBody = document.getElementById('tabelaDadosBody');
    const tabelaSectionContainer = document.getElementById('tabelaSectionContainer');
    const tituloTabela = document.getElementById('tituloTabela');
    const searchInput = document.getElementById('searchInput');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const modalCampanhas = document.getElementById('modalCampanhas');
    const tabelaCampanhas = document.getElementById('tabelaCampanhas');
    const tabelaCampanhasBody = document.getElementById('tabelaCampanhasBody');
    const campanhasSpinner = document.getElementById('campanhasSpinner');
    const tituloModalCampanhas = document.getElementById('tituloModalCampanhas');
    const modalNovaCampanha = document.getElementById('modalNovaCampanha');

    // ============================================
    // EVENT LISTENERS
    // ============================================
    
    btnAtivo.addEventListener('click', () => filtrarPorStatus('Ativo'));
    btnInativo.addEventListener('click', () => filtrarPorStatus('Inativo'));
    btnCancelar.addEventListener('click', fecharModal);
    document.querySelector('.close').addEventListener('click', fecharModal);
    document.getElementById('closeCampanhas').addEventListener('click', fecharModalCampanhas);
    document.getElementById('closeNovaCampanha').addEventListener('click', fecharModalNovaCampanha);
    document.getElementById('btnAdicionarCampanha').addEventListener('click', abrirModalNovaCampanha);
    document.getElementById('btnCancelNovaCampanha').addEventListener('click', fecharModalNovaCampanha);
    document.getElementById('selectEstado').addEventListener('change', atualizarCidades);
    document.getElementById('formNovaCampanha').addEventListener('submit', salvarNovaCampanha);
    formulario.addEventListener('submit', salvarRegistro);

    // Inicializar dados na p√°gina
    carregarDados();
    inicializarSelects();

    // ============================================
    // FILTROS E BUSCA
    // ============================================

    window.addEventListener('load', carregarDados);

    // ============================================
    // FUN√á√ïES PRINCIPAIS
    // ============================================

    async function carregarDados() {
      try {
        loadingSpinner.style.display = 'block';
        errorMessage.classList.remove('active');
        
        const response = await fetch(`${API_BASE}/dados`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Erro HTTP ${response.status}: ${errorData.erro || response.statusText}`);
        }
        
        dados = await response.json();
        
        if (!Array.isArray(dados)) {
          dados = [];
        }
        
        loadingSpinner.style.display = 'none';
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        mostrarErro(`‚ùå Erro ao carregar dados: ${error.message}`);
        dados = [];
        loadingSpinner.style.display = 'none';
      }
    }


    function filtrarTabela() {
      const termo = searchInput.value.toLowerCase();
      const linhas = tabelaDadosBody.querySelectorAll('tr');
      
      linhas.forEach(linha => {
        const texto = linha.textContent.toLowerCase();
        if (texto.includes(termo)) {
          linha.style.display = '';
        } else {
          linha.style.display = 'none';
        }
      });
    }

    function filtrarPorStatus(status) {
      statusFiltroAtual = status;
      
      // Atualizar t√≠tulo
      tituloTabela.textContent = status === 'Ativo' ? 'Campanhas Ativas' : 'Campanhas Inativas';
      
      // Atualizar estilos dos bot√µes
      if (status === 'Ativo') {
        btnAtivo.classList.add('active');
        btnInativo.classList.remove('active');
      } else {
        btnInativo.classList.add('active');
        btnAtivo.classList.remove('active');
      }
      
      // Mostrar tabela
      tabelaSectionContainer.style.display = 'block';
      
      // Determinar o status da campanha correspondente
      const statusCampanha = status === 'Ativo' ? 'Ativa' : 'Inativa';
      
      // Filtrar dados por status de campanha
      const dadosFiltrados = dados.filter(registro => {
        return registro['Status Campanha'] === statusCampanha;
      });
      
      // Atualizar tabela com dados filtrados
      tabelaDadosBody.innerHTML = '';
      
      // Obter clientes √∫nicos que t√™m campanhas com este status
      const clientesUnicos = {};
      dadosFiltrados.forEach((registro) => {
        const cliente = registro['Cliente'] || '-';
        if (!clientesUnicos[cliente]) {
          clientesUnicos[cliente] = {
            nome: cliente,
            campanhas: 0,
            registros: []
          };
        }
        clientesUnicos[cliente].campanhas += 1;
        clientesUnicos[cliente].registros.push(registro);
      });
      
      const clientes = Object.values(clientesUnicos).sort((a, b) => 
        a.nome.localeCompare(b.nome)
      );
      
      if (clientes.length === 0) {
        tabelaDadosBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 30px;">Nenhum cliente encontrado com campanhas ' + statusCampanha.toLowerCase() + '</td></tr>';
        return;
      }
      
      clientes.forEach((cliente, index) => {
        const linha = document.createElement('tr');
        
        linha.innerHTML = `
          <td><strong>${cliente.nome}</strong></td>
          <td>${cliente.campanhas}</td>
          <td>
            <div class="table-actions">
              <button class="btn-view" onclick="abrirModalCampanhas('${cliente.nome}', '${statusCampanha}')">Visualizar Campanha</button>
            </div>
          </td>
        `;
        
        tabelaDadosBody.appendChild(linha);
      });
      
      // Atualizar listener de busca
      searchInput.addEventListener('input', filtrarTabela);
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================

    function abrirModalNovoRegistro() {
      registroEmEdicao = null;
      formulario.reset();
      document.getElementById('modalTitulo').textContent = 'Novo Cliente';
      modal.classList.add('active');
    }

    function abrirModalEditar(nomeCliente) {
      registroEmEdicao = nomeCliente;
      
      const primeiroRegistro = dados.find(d => d['Cliente'] === nomeCliente);
      
      if (!primeiroRegistro) {
        mostrarErro('Cliente n√£o encontrado');
        return;
      }
      
      document.getElementById('modalTitulo').textContent = 'Editar Cliente: ' + nomeCliente;
      
      Object.keys(primeiroRegistro).forEach(chave => {
        const elemento = document.querySelector(`[name="${chave}"]`);
        if (elemento) {
          elemento.value = primeiroRegistro[chave];
        }
      });
      
      modal.classList.add('active');
    }

    function fecharModal() {
      modal.classList.remove('active');
      registroEmEdicao = null;
      formulario.reset();
    }

    function confirmarDeletar(nomeCliente) {
      document.getElementById('msgConfirmacao').textContent = 
        `Tem certeza que deseja deletar TODOS os registros do cliente "${nomeCliente}"? Esta a√ß√£o n√£o pode ser desfeita.`;
      
      btnConfirmarDelete.onclick = () => deletarCliente(nomeCliente);
      modalConfirmacao.classList.add('active');
    }

    document.addEventListener('click', (e) => {
      if (e.target === modalConfirmacao) {
        modalConfirmacao.classList.remove('active');
      }
    });

    btnCancelarDelete.addEventListener('click', () => {
      modalConfirmacao.classList.remove('active');
    });

    // ============================================
    // MODAL DE CAMPANHAS
    // ============================================

    function abrirModalCampanhas(nomeCliente, status) {
      campanhasSpinner.style.display = 'block';
      tabelaCampanhas.style.display = 'none';
      
      tituloModalCampanhas.textContent = `Visualizar Campanha - ${nomeCliente} (${status})`;
      modalCampanhas.classList.add('active');
      
      // Filtrar campanhas deste cliente com o status correspondente (baseado em Status Campanha)
      const campanhasDoCliente = dados.filter(registro => {
        return registro['Cliente'] === nomeCliente && 
               registro['Status Campanha'] === status;
      });
      
      // Renderizar tabela de campanhas
      tabelaCampanhasBody.innerHTML = '';
      
      if (campanhasDoCliente.length === 0) {
        tabelaCampanhasBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">Nenhuma campanha encontrada</td></tr>';
        campanhasSpinner.style.display = 'none';
        tabelaCampanhas.style.display = 'table';
        return;
      }
      
      campanhasDoCliente.forEach((campanha, index) => {
        const linha = document.createElement('tr');
        const statusCampanha = campanha['Status Campanha'] || '-';
        
        linha.innerHTML = `
          <td>${campanha['Cidade'] || '-'}</td>
          <td>${campanha['Exibidora'] || '-'}</td>
          <td>${campanha['Tipo de OOH'] || '-'}</td>
          <td>${campanha['In√≠cio da campanha'] || '-'}</td>
          <td>${campanha['T√©rmino da campanha'] || '-'}</td>
          <td><span class="status ${statusCampanha.toLowerCase()}">${statusCampanha}</span></td>
          <td>
            <div class="table-actions-small">
              <button class="btn-edit-small" onclick="editarCampanha(${index})">‚úèÔ∏è Editar</button>
              <button class="btn-delete-small" onclick="deletarCampanha(${index})">üóëÔ∏è Deletar</button>
            </div>
          </td>
        `;
        
        tabelaCampanhasBody.appendChild(linha);
      });
      
      campanhasSpinner.style.display = 'none';
      tabelaCampanhas.style.display = 'table';
    }

    function fecharModalCampanhas() {
      modalCampanhas.classList.remove('active');
    }

    // ============================================
    // MODAL NOVA CAMPANHA
    // ============================================

    function abrirModalNovaCampanha() {
      modalNovaCampanha.classList.add('active');
    }

    function fecharModalNovaCampanha() {
      modalNovaCampanha.classList.remove('active');
      document.getElementById('formNovaCampanha').reset();
    }

    async function salvarNovaCampanha(e) {
      e.preventDefault();
      
      try {
        // Validar se Apps Script URL foi configurado
        if (APPS_SCRIPT_URL.includes('YOUR_DEPLOYMENT_ID')) {
          throw new Error('Apps Script URL n√£o foi configurado. Verifique o README.md para instru√ß√µes.');
        }

        console.log('üìù Iniciando salvarNovaCampanha...');
        console.log('üîó APPS_SCRIPT_URL:', APPS_SCRIPT_URL);

        const novaLinha = {
          'Cliente': document.getElementById('inputCliente').value,
          'Status Cliente': '',
          'Campanha': document.getElementById('inputCampanha').value,
          'Tipo de OOH': document.getElementById('inputTipoOOH').value,
          'Status Campanha': document.getElementById('selectStatus').value,
          'Regi√£o': document.getElementById('selectRegiao').value,
          'Estado': document.getElementById('selectEstado').value,
          'Cidade': document.getElementById('selectCidade').value,
          'Exibidora': document.getElementById('inputExibidora').value,
          'URL logo exibidora': '',
          'M√™s de exibi√ß√£o': document.getElementById('selectMes').value,
          'In√≠cio da campanha': document.getElementById('inputDataInicio').value,
          'T√©rmino da campanha': document.getElementById('inputDataFim').value,
          'Impactos Total': document.getElementById('inputImpactos').value,
          'Investimento': 'R$ ' + parseFloat(document.getElementById('inputInvestimento').value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        };

        console.log('üìä Dados a enviar:', JSON.stringify(novaLinha));

        // Mostrar modal de loading
        const modalLoading = document.getElementById('modalLoading');
        modalLoading.classList.add('active');
        const loadingState = document.getElementById('loadingState');
        const successState = document.getElementById('successState');
        loadingState.classList.remove('hidden');
        successState.classList.remove('active');

        // Enviar para Google Apps Script
        console.log('üöÄ Enviando POST para Apps Script...');
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(novaLinha)
        });

        console.log('‚úì Resposta recebida');
        console.log('Status:', response.status);
        console.log('OK:', response.ok);

        // Mostrar sucesso
        setTimeout(() => {
          loadingState.classList.add('hidden');
          successState.classList.add('active');
        }, 500);

        // Fechar modal e limpar formul√°rio ap√≥s 2 segundos
        setTimeout(() => {
          modalLoading.classList.remove('active');
          alert('Campanha adicionada com sucesso!');
          fecharModalNovaCampanha();
          document.getElementById('formNovaCampanha').reset();
          console.log('‚ôªÔ∏è Recarregando dados em 2 segundos...');
          setTimeout(carregarDados, 2000);
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Erro completo:', error);
        console.error('Stack:', error.stack);
        
        // Fechar modal de loading em caso de erro
        const modalLoading = document.getElementById('modalLoading');
        modalLoading.classList.remove('active');
        
        alert('Erro ao adicionar campanha: ' + error.message);
      }
    }

    // ============================================
    // DADOS GEOGR√ÅFICOS - CARREGADOS VIA GEONAMES API
    // ============================================
    function inicializarSelects() {
      const selectRegiao = document.getElementById('selectRegiao');
      const selectEstado = document.getElementById('selectEstado');

      // Carrega estados do Brasil via API IBGE (suporta HTTPS)
      fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados')
        .then(res => res.json())
        .then(data => {
          // Agrupar por regi√£o
          const estadosPorRegiao = {
            'Norte': [],
            'Nordeste': [],
            'Centro-Oeste': [],
            'Sudeste': [],
            'Sul': []
          };

          // Mapa de regi√µes por sigla
          const regiaoSigla = {
            'AC': 'Norte', 'AP': 'Norte', 'AM': 'Norte', 'PA': 'Norte', 'RO': 'Norte', 'RR': 'Norte', 'TO': 'Norte',
            'AL': 'Nordeste', 'BA': 'Nordeste', 'CE': 'Nordeste', 'MA': 'Nordeste', 'PB': 'Nordeste', 'PE': 'Nordeste', 'PI': 'Nordeste', 'RN': 'Nordeste', 'SE': 'Nordeste',
            'DF': 'Centro-Oeste', 'GO': 'Centro-Oeste', 'MT': 'Centro-Oeste', 'MS': 'Centro-Oeste',
            'ES': 'Sudeste', 'MG': 'Sudeste', 'RJ': 'Sudeste', 'SP': 'Sudeste',
            'PR': 'Sul', 'RS': 'Sul', 'SC': 'Sul'
          };

          // Preencher regi√µes
          Object.keys(estadosPorRegiao).forEach(regiao => {
            const option = document.createElement('option');
            option.value = regiao;
            option.textContent = regiao;
            selectRegiao.appendChild(option);
          });

          // Armazenar dados globais
          window.estadosPorRegiao = estadosPorRegiao;
          window.estadosIBGE = {}; // Mapear nome completo -> ID IBGE
          
          // Procesar estados
          data.forEach(state => {
            const nome = state.nome;
            const sigla = state.sigla;
            const id = state.id;
            const regiao = regiaoSigla[sigla];
            
            if (regiao && estadosPorRegiao[regiao]) {
              estadosPorRegiao[regiao].push(nome);
              window.estadosIBGE[nome] = { sigla, id };
            }
          });

          // Listener para atualizar estados
          selectRegiao.addEventListener('change', function() {
            selectEstado.innerHTML = '<option value="">Selecione...</option>';
            const estadosSelecionados = window.estadosPorRegiao[this.value] || [];
            estadosSelecionados.sort().forEach(estado => {
              const option = document.createElement('option');
              option.value = estado;
              const uf = window.estadosIBGE[estado]?.sigla || '??';
              option.textContent = `${uf} - ${estado}`;
              selectEstado.appendChild(option);
            });
          });
        })
        .catch(err => {
          console.error('Erro ao carregar estados:', err);
          carregarEstadosLocal();
        });
    }

    function carregarEstadosLocal() {
      // Fallback para dados locais se API IBGE falhar
      const selectRegiao = document.getElementById('selectRegiao');
      const selectEstado = document.getElementById('selectEstado');
      
      const dadosBrasil = {
        'Norte': ['Acre', 'Amap√°', 'Amazonas', 'Par√°', 'Rond√¥nia', 'Roraima', 'Tocantins'],
        'Nordeste': ['Alagoas', 'Bahia', 'Cear√°', 'Maranh√£o', 'Para√≠ba', 'Pernambuco', 'Piau√≠', 'Rio Grande do Norte', 'Sergipe'],
        'Centro-Oeste': ['Distrito Federal', 'Goi√°s', 'Mato Grosso', 'Mato Grosso do Sul'],
        'Sudeste': ['Esp√≠rito Santo', 'Minas Gerais', 'Rio de Janeiro', 'S√£o Paulo'],
        'Sul': ['Paran√°', 'Rio Grande do Sul', 'Santa Catarina']
      };

      // Mapa de estados para UF (fallback)
      const estadoCodigo = {
        'Acre': 'AC',
        'Alagoas': 'AL',
        'Amap√°': 'AP',
        'Amazonas': 'AM',
        'Bahia': 'BA',
        'Cear√°': 'CE',
        'Distrito Federal': 'DF',
        'Esp√≠rito Santo': 'ES',
        'Goi√°s': 'GO',
        'Maranh√£o': 'MA',
        'Mato Grosso': 'MT',
        'Mato Grosso do Sul': 'MS',
        'Minas Gerais': 'MG',
        'Par√°': 'PA',
        'Para√≠ba': 'PB',
        'Paran√°': 'PR',
        'Pernambuco': 'PE',
        'Piau√≠': 'PI',
        'Rio de Janeiro': 'RJ',
        'Rio Grande do Norte': 'RN',
        'Rio Grande do Sul': 'RS',
        'Rond√¥nia': 'RO',
        'Roraima': 'RR',
        'Santa Catarina': 'SC',
        'S√£o Paulo': 'SP',
        'Sergipe': 'SE',
        'Tocantins': 'TO'
      };

      window.estadoCodigo = estadoCodigo; // Armazenar para atualizarCidades usar

      Object.keys(dadosBrasil).forEach(regiao => {
        const option = document.createElement('option');
        option.value = regiao;
        option.textContent = regiao;
        selectRegiao.appendChild(option);
      });

      selectRegiao.addEventListener('change', function() {
        selectEstado.innerHTML = '<option value="">Selecione...</option>';
        const estadosSelecionados = dadosBrasil[this.value] || [];
        estadosSelecionados.forEach(estado => {
          const option = document.createElement('option');
          option.value = estado; // Guardar nome completo
          const uf = estadoCodigo[estado]; // Buscar UF
          option.textContent = `${uf} - ${estado}`; // Exibir como "SP - S√£o Paulo"
          selectEstado.appendChild(option);
        });
      });
    }

    function atualizarCidades() {
      const selectEstado = document.getElementById('selectEstado').value;
      const selectCidade = document.getElementById('selectCidade');

      selectCidade.innerHTML = '<option value=""><span style="font-style: italic;">Carregando cidades...</span></option>';

      if (!selectEstado) {
        selectCidade.innerHTML = '<option value="">Selecione um estado primeiro</option>';
        return;
      }

      // Buscar ID IBGE do estado
      const estadoInfo = window.estadosIBGE ? window.estadosIBGE[selectEstado] : null;
      
      if (!estadoInfo) {
        selectCidade.innerHTML = '<option value="">Estado n√£o encontrado</option>';
        return;
      }

      // Usar API IBGE para buscar munic√≠pios
      fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${estadoInfo.id}/municipios`)
        .then(res => res.json())
        .then(data => {
          selectCidade.innerHTML = '<option value="">Selecione...</option>';
          
          if (!data || data.length === 0) {
            selectCidade.innerHTML = '<option value="">Nenhuma cidade encontrada</option>';
            return;
          }
          
          // Extrair e ordenar nomes das cidades
          const cidades = data.map(city => city.nome).sort();
          
          cidades.forEach(cidade => {
            const option = document.createElement('option');
            option.value = cidade;
            option.textContent = cidade;
            selectCidade.appendChild(option);
          });
        })
        .catch(err => {
          console.error('Erro ao carregar cidades:', err);
          selectCidade.innerHTML = '<option value="">Erro ao carregar cidades</option>';
        });
    }

    function editarCampanha(index) {
      alert('Fun√ß√£o de editar campanha ser√° implementada');
    }

    function deletarCampanha(index) {
      alert('Fun√ß√£o de deletar campanha ser√° implementada');
    }

    function alterarStatusCampanha(index) {
      alert('Fun√ß√£o de alterar status ser√° implementada');
    }

    // ============================================
    // CRUD OPERATIONS
    // ============================================

    async function salvarRegistro(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(formulario);
        const registro = Object.fromEntries(formData);
        
        if (registroEmEdicao !== null) {
          // UPDATE
          const response = await fetch(`${API_BASE}/dados/0`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(registro)
          });
          
          if (!response.ok) {
            throw new Error('Erro ao atualizar registro');
          }
          
          mostrarSucesso('Registro atualizado com sucesso!');
        } else {
          // CREATE
          const response = await fetch(`${API_BASE}/dados`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(registro)
          });
          
          if (!response.ok) {
            throw new Error('Erro ao criar registro');
          }
          
          mostrarSucesso('Registro criado com sucesso!');
        }
        
        carregarDados();
        fecharModal();
      } catch (error) {
        console.error('Erro ao salvar:', error);
        mostrarErro(error.message || 'Erro ao salvar registro');
      }
    }

    async function deletarCliente(nomeCliente) {
      try {
        const indicesParaDeletar = dados
          .map((d, idx) => d['Cliente'] === nomeCliente ? idx : -1)
          .filter(idx => idx !== -1)
          .sort((a, b) => b - a);
        
        for (const idx of indicesParaDeletar) {
          const response = await fetch(`${API_BASE}/dados/${idx}`, {
            method: 'DELETE'
          });
          
          if (!response.ok) {
            throw new Error('Erro ao deletar registro');
          }
        }
        
        dados = dados.filter(d => d['Cliente'] !== nomeCliente);
        
        modalConfirmacao.classList.remove('active');
        mostrarSucesso(`Cliente "${nomeCliente}" deletado com sucesso!`);
      } catch (error) {
        console.error('Erro ao deletar cliente:', error);
        mostrarErro(error.message || 'Erro ao deletar cliente');
      }
    }

    // ============================================
    // NOTIFICA√á√ïES
    // ============================================

    function mostrarErro(mensagem) {
      errorMessage.textContent = mensagem;
      errorMessage.classList.add('active');
      setTimeout(() => {
        errorMessage.classList.remove('active');
      }, 5000);
    }

    function mostrarSucesso(mensagem) {
      const notif = document.createElement('div');
      notif.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        z-index: 2000;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      `;
      notif.textContent = '‚úì ' + mensagem;
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.remove();
      }, 3000);
    }

    // ============================================
    // UTILIDADES
    // ============================================

    function formatarNumero(num) {
      return new Intl.NumberFormat('pt-BR').format(num);
    }

    const style = document.createElement('style');
    style.textContent = `
      .status {
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85em;
      }
      
      .status.ativo {
        background: #c8e6c9;
        color: #2e7d32;
      }
      
      .status.inativo {
        background: #ffcdd2;
        color: #c62828;
      }
      
      .status.ativa {
        background: #c8e6c9;
        color: #2e7d32;
      }
      
      .status.inativa {
        background: #ffcdd2;
        color: #c62828;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
